<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />

  <title>Proof of Build</title>
  <meta name="description" content="A Base-native collectible for early miniapp creators and supporters. Mint as many as you want, keep it as your onchain builder badge." />

  <!-- Open Graph (untuk preview link biasa) -->
  <meta property="og:title" content="Proof of Build" />
  <meta property="og:description" content="Mint a Base-native builder badge. 0.0001 ETH on Base." />
  <meta property="og:image" content="https://YOUR_DOMAIN/og.png" />
  <meta property="og:url" content="https://YOUR_DOMAIN/" />
  <meta name="theme-color" content="#0B1117" />

  <!-- ===== Farcaster Frame meta (vNext) ===== -->
  <meta name="fc:frame" content="vNext" />
  <meta name="fc:frame:image" content="https://YOUR_DOMAIN/og.png" />

  <!-- Button 1: buka halaman ini dengan auto-mint UI -->
  <meta name="fc:frame:button:1" content="Mint POB" />
  <meta name="fc:frame:button:1:action" content="link" />
  <meta name="fc:frame:button:1:target" content="https://YOUR_DOMAIN/?autostart=mint" />

  <!-- Button 2: lihat kontrak di BaseScan -->
  <meta name="fc:frame:button:2" content="View Contract" />
  <meta name="fc:frame:button:2:action" content="link" />
  <meta name="fc:frame:button:2:target" content="https://basescan.org/address/0x01b91784C9B80d7fEfb206E2E1FC63ef1616386C" />

  <!-- Button 3 (opsional): Share link -->
  <meta name="fc:frame:button:3" content="Share" />
  <meta name="fc:frame:button:3:action" content="link" />
  <meta name="fc:frame:button:3:target" content="https://YOUR_DOMAIN/" />

  <link rel="icon" href="/icon.png" />
  <style>
    :root {
      --bg: #0b1117;
      --card: #0e1621;
      --muted: #9fb3c8;
      --text: #e6f0ff;
      --primary: #3aa0ff;
      --accent: #10b1b7;
      --ring: #1b2b3a;
      --shadow: 0 12px 40px rgba(0,0,0,.35);
      --radius: 18px;
    }
    * { box-sizing: border-box; }
    html,body { height:100%; }
    body {
      margin:0; background: radial-gradient(1200px 600px at 50% -200px, rgba(33,106,163,.25), transparent 60%) , var(--bg);
      font: 16px/1.5 system-ui, -apple-system, Segoe UI, Roboto, Inter, sans-serif;
      color: var(--text);
      display:flex; align-items:flex-start; justify-content:center; padding:32px 16px 64px;
    }
    .wrap { width:100%; max-width: 880px; }
    .hero {
      background: linear-gradient(180deg, #0f1a27 0%, #0b1117 100%);
      border: 1px solid var(--ring);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow: hidden;
    }
    .media {
      aspect-ratio: 1000 / 679;
      background: #05080c;
      display:block;
      width:100%;
      border-bottom: 1px solid var(--ring);
    }
    .media img { width:100%; height:100%; object-fit: cover; display:block; }
    .content { padding: 20px 22px 8px; }
    h1 { margin: 0 0 6px; font-size: 28px; letter-spacing:.2px; }
    .row { display:flex; gap:18px; flex-wrap:wrap; color: var(--muted); font-weight:600; }
    .row span { display:inline-flex; gap:8px; align-items:center; }
    .muted { color: var(--muted); }
    .grid {
      display:grid; gap:16px; grid-template-columns: 1fr auto;
      padding: 18px 22px 20px;
      border-top: 1px solid var(--ring);
      align-items: center;
    }
    .qty {
      display:flex; align-items:center; justify-content:space-between;
      background: #0c141f; border:1px solid #1a2733; color:#d9e7ff;
      border-radius: 14px; padding: 10px 12px; min-width: 240px;
    }
    .qty input {
      width: 80px; background:transparent; border:0; outline:none; color:inherit;
      font: inherit; font-weight:700; text-align:left;
    }
    .btn {
      appearance:none; border:0; border-radius: 14px; padding: 12px 20px;
      font-weight:700; color:#001014; background:
      radial-gradient(180px 80px at 50% -20%, rgba(255,255,255,.35), transparent 60%),
      linear-gradient(90deg, var(--primary), #00d1ff);
      box-shadow: 0 6px 24px rgba(28,141,255,.35);
      cursor:pointer;
    }
    .addr {
      margin: 8px 22px 22px; display:flex; gap:10px; flex-wrap:wrap; align-items:center;
    }
    .copy {
      font-size: 14px; color: var(--muted);
      padding:8px 10px; border:1px dashed #213244; border-radius: 10px;
      background:#0c141f;
    }
    .hint { margin:10px 22px 0; color:#7f95aa; font-size:13px; }
    .ok { color:#26d07c; font-weight:700; }
    .warn { color:#ffb84d; font-weight:600; }
    @media (max-width:640px){ .grid{ grid-template-columns: 1fr; } .qty{ min-width:unset; } }
  </style>
</head>
<body>
  <main class="wrap">
    <section class="hero" id="top">
      <div class="media">
        <!-- og.png 1000x679 -->
        <img src="/og.png" alt="POB artwork" />
      </div>

      <div class="content">
        <h1>Proof of Build</h1>
        <div class="row">
          <span>Chain: <strong class="muted">Base</strong></span>
          <span>Price: <strong class="muted">0.0001 ETH</strong></span>
          <span>Contract: <a class="muted" href="https://basescan.org/address/0x01b91784C9B80d7fEfb206E2E1FC63ef1616386C" target="_blank" rel="noopener">0x01b9...6386C</a></span>
        </div>
        <p class="muted" style="margin:10px 0 0">
          Proof of Build is a Base-native collectible for early miniapp creators and supporters.
          Mint as many as you want, keep it as your onchain builder badge.
        </p>
      </div>

      <div class="grid" id="mint">
        <div class="qty">
          <label for="q" style="opacity:.85">Quantity</label>
          <input id="q" type="number" min="1" step="1" value="1" inputmode="numeric" />
        </div>
        <button id="mintBtn" class="btn">Mint POB</button>
      </div>

      <div class="addr">
        <span class="copy">Network: Base (8453)</span>
        <span class="copy">You hold: <span id="hold" class="muted">–</span> POB</span>
        <span id="status" class="copy">Wallet: <span class="warn">not connected</span></span>
      </div>

      <p class="hint">
        If you cast this link on Warpcast and the preview doesn’t show buttons, make sure there is
        <strong>no extra space or newline after the URL</strong> in your cast.
      </p>
    </section>
  </main>

  <!-- ===== Minimal web3 (ethers v6 + wagmi-like bare connect) ===== -->
  <script type="module">
    import { BrowserProvider, Contract, parseEther } from "https://cdn.jsdelivr.net/npm/ethers@6.13.4/dist/ethers.min.js";

    const CONTRACT = "0x01b91784C9B80d7fEfb206E2E1FC63ef1616386C";
    const CHAIN_ID_HEX = "0x2105"; // 8453 Base
    // ABI minimum: claim(), balanceOf(address,id), getActiveClaimConditionId(uint256)
    const ABI = [
      {"inputs":[{"internalType":"address","name":"account","type":"address"},{"internalType":"uint256","name":"id","type":"uint256"}],"name":"balanceOf","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
      {"inputs":[{"internalType":"uint256","name":"_tokenId","type":"uint256"}],"name":"getActiveClaimConditionId","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
      {"inputs":[{"internalType":"address","name":"_receiver","type":"address"},{"internalType":"uint256","name":"_tokenId","type":"uint256"},{"internalType":"uint256","name":"_quantity","type":"uint256"},{"internalType":"address","name":"_currency","type":"address"},{"internalType":"uint256","name":"_pricePerToken","type":"uint256"},{"components":[{"internalType":"bytes32[]","name":"proof","type":"bytes32[]"},{"internalType":"uint256","name":"quantityLimitPerWallet","type":"uint256"},{"internalType":"uint256","name":"pricePerToken","type":"uint256"},{"internalType":"address","name":"currency","type":"address"}],"internalType":"struct IDrop1155.AllowlistProof","name":"_allowlistProof","type":"tuple"},{"internalType":"bytes","name":"_data","type":"bytes"}],"name":"claim","outputs":[],"stateMutability":"payable","type":"function"}
    ];

    const state = { provider:null, signer:null, account:null, contract:null, tokenId:0n, priceWei: parseEther("0.0001") };

    const $ = sel => document.querySelector(sel);
    const statusEl = $("#status"); const holdEl = $("#hold"); const qInput = $("#q"); const mintBtn = $("#mintBtn");

    async function ensureChain() {
      const eth = window.ethereum;
      if (!eth) throw new Error("No wallet found");
      const cur = await eth.request({ method: "eth_chainId" });
      if (cur !== CHAIN_ID_HEX) {
        await eth.request({ method: "wallet_switchEthereumChain", params: [{ chainId: CHAIN_ID_HEX }] });
      }
    }

    async function connect() {
      await ensureChain();
      state.provider = new BrowserProvider(window.ethereum);
      state.signer = await state.provider.getSigner();
      state.account = await state.signer.getAddress();
      state.contract = new Contract(CONTRACT, ABI, state.signer);
      // tokenId aktif (umumnya 0 untuk single drop)
      try { state.tokenId = await state.contract.getActiveClaimConditionId(0); state.tokenId = 0n; } catch { state.tokenId = 0n; }
      statusEl.innerHTML = "Wallet: <span class='ok'>connected</span>";
      await refreshHold();
    }

    async function refreshHold() {
      if (!state.account || !state.contract) return;
      try {
        const bal = await state.contract.balanceOf(state.account, state.tokenId);
        holdEl.textContent = bal.toString();
      } catch { holdEl.textContent = "0"; }
    }

    async function mint() {
      try {
        if (!state.signer) await connect();
        const qty = BigInt(Math.max(1, parseInt(qInput.value || "1", 10)));
        const total = state.priceWei * qty;
        const tx = await state.contract.claim(
          state.account,            // _receiver
          state.tokenId,            // _tokenId
          qty,                      // _quantity
          "0x0000000000000000000000000000000000000000", // _currency (native)
          state.priceWei,           // _pricePerToken
          { proof: [], quantityLimitPerWallet: 0, pricePerToken: 0, currency: "0x0000000000000000000000000000000000000000" },
          "0x",                     // _data
          { value: total }
        );
        statusEl.textContent = "Waiting for confirmation…";
        await tx.wait();
        statusEl.innerHTML = "Minted! ✅";
        await refreshHold();
      } catch (e) {
        console.error(e);
        statusEl.innerHTML = "Error: " + (e?.shortMessage || e?.message || "failed");
      }
    }

    // UI wiring
    mintBtn.addEventListener("click", mint);

    // Auto start (untuk tombol Frame yang membuka /?autostart=mint)
    const params = new URLSearchParams(location.search);
    if (params.get("autostart") === "mint") {
      // kecilkan jeda agar wallet prompt muncul setelah load
      setTimeout(async () => { await connect(); await mint(); }, 300);
    }

    // Jika user klik "Connect wallet" (teks status), lakukan connect()
    statusEl.addEventListener("click", connect);
  </script>
</body>
</html>
