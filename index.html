<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Proof of Build â€¢ Base Miniapp</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta
    name="description"
    content="Proof of Build is a Base-native collectible for early miniapp creators and supporters. Mint once, keep forever."
  />

  <!-- Open Graph -->
  <meta property="og:title" content="Proof of Build" />
  <meta
    property="og:description"
    content="Mint your Proof of Build on Base for 0.0001 ETH. A collectible for early miniapp builders & supporters."
  />
  <meta property="og:image" content="https://pob-lyart.vercel.app/og.png" />
  <meta property="og:url" content="https://pob-lyart.vercel.app" />
  <meta property="og:type" content="website" />

  <!-- Farcaster MiniApp -->
  <meta
    name="fc:miniapp"
    content='{
      "version":"1",
      "imageUrl":"https://pob-lyart.vercel.app/og.png",
      "button":{
        "title":"Mint Proof of Build",
        "action":{
          "type":"launch_miniapp",
          "name":"Proof of Build",
          "url":"https://pob-lyart.vercel.app",
          "splashImageUrl":"https://pob-lyart.vercel.app/og.png",
          "splashBackgroundColor":"#020617"
        }
      }
    }'
  />

  <link rel="icon" type="image/png" href="https://pob-lyart.vercel.app/icon.png" />

  <style>
    * {
      box-sizing: border-box;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    body {
      margin: 0;
      min-height: 100vh;
      background: radial-gradient(circle at top, #020617, #020617 70%);
      color: #e5e7eb;
      display: flex;
      justify-content: center;
    }

    main {
      width: 100%;
      max-width: 880px;
      padding: 24px 16px 40px;
    }

    a {
      color: #60a5fa;
      text-decoration: none;
    }
    a:hover {
      text-decoration: underline;
    }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 4px 12px;
      border-radius: 999px;
      background: rgba(34, 197, 94, 0.1);
      color: #bbf7d0;
      font-size: 11px;
      margin-bottom: 12px;
    }
    .pill-dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: radial-gradient(circle, #22c55e, #15803d);
      box-shadow: 0 0 10px #22c55e;
    }

    .card {
      background: rgba(15, 23, 42, 0.96);
      border-radius: 18px;
      border: 1px solid rgba(148, 163, 184, 0.35);
      padding: 18px 18px 20px;
      margin-bottom: 16px;
      box-shadow: 0 22px 60px rgba(15, 23, 42, 0.9);
      backdrop-filter: blur(22px);
    }

    .header {
      display: flex;
      flex-wrap: wrap;
      gap: 16px;
      align-items: center;
    }

    .icon-wrap {
      width: 72px;
      height: 72px;
      border-radius: 24px;
      border: 1px solid rgba(148, 163, 184, 0.5);
      background: radial-gradient(circle at 30% 30%, #38bdf8, #020617 70%);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 800;
      font-size: 24px;
      letter-spacing: 1px;
      color: #e0f2fe;
      box-shadow: 0 18px 45px rgba(37, 99, 235, 0.9);
    }

    h1 {
      margin: 0;
      font-size: 26px;
      color: #f9fafb;
    }

    .subtitle {
      margin: 4px 0 12px;
      font-size: 14px;
      color: #9ca3af;
    }

    .row {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 6px;
      font-size: 13px;
    }
    .row > div {
      flex: 1 1 160px;
    }
    .label {
      font-size: 12px;
      color: #9ca3af;
    }
    .value {
      margin-top: 2px;
      font-size: 13px;
      color: #e5e7eb;
      font-weight: 600;
    }
    .mono {
      font-family: "JetBrains Mono", "Fira Code", monospace;
      font-size: 12px;
    }

    .btn {
      border: none;
      border-radius: 999px;
      padding: 9px 18px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
    }

    #connectBtn {
      background: rgba(37, 99, 235, 0.12);
      border: 1px solid rgba(59, 130, 246, 0.9);
      color: #bfdbfe;
      margin-top: 4px;
    }
    #connectBtn:disabled {
      opacity: 0.75;
      cursor: default;
    }

    #mintBtn {
      background: linear-gradient(135deg, #22c55e, #38bdf8);
      color: #ecfeff;
      box-shadow: 0 14px 40px rgba(34, 197, 94, 0.7);
      min-width: 140px;
    }
    #mintBtn:disabled {
      opacity: 0.7;
      box-shadow: none;
      cursor: default;
    }

    .qty-wrap {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-top: 10px;
    }
    .qty-input-box {
      flex: 1;
      display: flex;
      align-items: center;
      border-radius: 999px;
      background: #020617;
      border: 1px solid rgba(55, 65, 81, 0.9);
      padding: 8px 14px;
      gap: 8px;
    }
    #qtyInput {
      flex: 1;
      border: none;
      background: transparent;
      color: #f9fafb;
      font-size: 16px;
      outline: none;
    }
    .qty-suffix {
      font-size: 13px;
      color: #9ca3af;
    }

    .muted {
      font-size: 13px;
      color: #9ca3af;
    }

    .status {
      margin-top: 10px;
      font-size: 12px;
      min-height: 16px;
    }

    .stats-list {
      margin-top: 8px;
      font-size: 13px;
      color: #d1d5db;
    }

    .stats-list div {
      margin-bottom: 3px;
    }

    .hint {
      margin-top: 10px;
      font-size: 11px;
      color: #6b7280;
    }

    @media (max-width: 720px) {
      main {
        padding: 18px 10px 30px;
      }
      .card {
        padding: 16px 14px 18px;
      }
      h1 {
        font-size: 22px;
      }
    }
  </style>

  <!-- ethers v6 -->
  <script src="https://cdn.jsdelivr.net/npm/ethers@6.11.1/dist/ethers.umd.min.js"></script>
</head>
<body>
<main>

  <!-- HERO / HEADER -->
  <section class="card">
    <div class="pill">
      <span class="pill-dot"></span>
      Live on Base â€¢ Mint for 0.0001 ETH
    </div>

    <div class="header">
      <div class="icon-wrap">POB&gt;</div>
      <div>
        <h1>Proof of Build</h1>
        <p class="subtitle">
          A Base-native collectible for early miniapp creators and supporters.
          Mint once, keep forever.
        </p>
        <button id="connectBtn" class="btn">Connect wallet</button>
      </div>
    </div>

    <div class="row" style="margin-top:14px;">
      <div>
        <div class="label">Contract</div>
        <div class="value mono">
          <a href="https://basescan.org/address/0x01b91784C9B80d7fEfb206E2E1FC63ef1616386C" target="_blank">
            0x01b9...6386C
          </a>
        </div>
      </div>
      <div>
        <div class="label">Network</div>
        <div class="value">Base Mainnet (8453)</div>
      </div>
      <div>
        <div class="label">Price</div>
        <div class="value" id="pricePerNft">Loadingâ€¦</div>
      </div>
      <div>
        <div class="label">Max per wallet</div>
        <div class="value" id="maxPerWallet">1 Proof of Build</div>
      </div>
    </div>
  </section>

  <!-- MINT CARD -->
  <section class="card">
    <h2 style="margin:0 0 6px;font-size:20px;color:#e5e7eb;">Mint your Proof of Build</h2>
    <p class="muted">
      Choose your contribution (fixed at 1 NFT per wallet). You&apos;ll receive
      <span class="mono">Proof of Build</span> directly to your address on Base.
    </p>

    <div class="label" style="margin-top:10px;">Quantity</div>
    <div class="qty-wrap">
      <div class="qty-input-box">
        <input id="qtyInput" type="number" min="1" max="1" value="1" />
        <span class="qty-suffix">NFT</span>
      </div>
      <button id="mintBtn" class="btn">Mint POB</button>
    </div>

    <p id="estText" class="muted" style="margin-top:8px;">
      Estimated: 1 Proof of Build â€¢ 0.0001 ETH
    </p>

    <p id="mintStatus" class="status"></p>

    <div class="stats-list">
      <div id="mintedText">Minted: loadingâ€¦</div>
    </div>

    <p class="hint">
      If you share this link on Warpcast and the preview card doesn&apos;t show:
      make sure there is **no extra space** after the URL in your cast.
      Delete any space/newline after the last character of the link.
    </p>
  </section>

  <!-- FOOTER -->
  <section class="card">
    <h3 style="margin:0 0 6px;font-size:16px;">About this drop</h3>
    <p class="muted">
      Proof of Build is a simple onchain memento for people who experiment with
      Base miniapps early. Mint is set to <span class="mono">0.0001 ETH</span>,
      1 per wallet, with a fixed supply configured on-chain via thirdweb.
    </p>
    <p class="muted" style="margin-top:6px;">
      This is not an investment. It&apos;s a small badge of curiosity and builder spirit.
    </p>
  </section>

</main>

<script>
  // ===== CONSTANTS =====
  const BASE_CHAIN_ID = 8453;
  const CONTRACT_ADDRESS = "0x01b91784C9B80d7fEfb206E2E1FC63ef1616386C";
  const TOKEN_ID = 0; // Proof of Build token ID (first lazy-minted token)

  // minimal ABI for this miniapp
  const POB_ABI = [
    "function totalSupply(uint256 id) view returns (uint256)",
    "function maxTotalSupply(uint256 id) view returns (uint256)",
    "function getActiveClaimConditionId(uint256 _tokenId) view returns (uint256)",
    "function getClaimConditionById(uint256 _tokenId,uint256 _conditionId) view returns (tuple(uint256 startTimestamp,uint256 maxClaimableSupply,uint256 supplyClaimed,uint256 quantityLimitPerWallet,bytes32 merkleRoot,uint256 pricePerToken,address currency,string metadata))",
    "function claim(address _receiver,uint256 _tokenId,uint256 _quantity,address _currency,uint256 _pricePerToken,(bytes32[] proof,uint256 quantityLimitPerWallet,uint256 pricePerToken,address currency) _allowlistProof,bytes _data) payable"
  ];

  // DOM
  const connectBtn = document.getElementById("connectBtn");
  const qtyInput   = document.getElementById("qtyInput");
  const mintBtn    = document.getElementById("mintBtn");
  const estText    = document.getElementById("estText");
  const statusEl   = document.getElementById("mintStatus");
  const mintedEl   = document.getElementById("mintedText");
  const priceLabel = document.getElementById("pricePerNft");
  const maxPerWalletLabel = document.getElementById("maxPerWallet");

  let readProvider;
  let writeProvider;
  let signer;
  let currentAccount = null;

  // on-chain claim data
  let onchainPricePerToken = null; // BigInt
  let onchainCurrency = null;      // address
  let quantityLimitPerWallet = null;
  let maxClaimableSupply = null;

  function setStatus(msg, ok) {
    if (!statusEl) return;
    statusEl.textContent = msg || "";
    if (!msg) {
      statusEl.style.color = "";
    } else {
      statusEl.style.color = ok ? "#4ade80" : "#f97373";
    }
  }

  // ===== LOAD STATS & CLAIM CONDITION =====
  async function loadStats() {
    try {
      readProvider = new ethers.JsonRpcProvider("https://mainnet.base.org");
      const contract = new ethers.Contract(CONTRACT_ADDRESS, POB_ABI, readProvider);

      // Read claim condition
      const condId = await contract.getActiveClaimConditionId(TOKEN_ID);
      const cond = await contract.getClaimConditionById(TOKEN_ID, condId);

      onchainPricePerToken = cond.pricePerToken;
      onchainCurrency = cond.currency;
      quantityLimitPerWallet = cond.quantityLimitPerWallet;
      maxClaimableSupply = cond.maxClaimableSupply;

      const priceEth = Number(ethers.formatEther(onchainPricePerToken));
      if (priceLabel) {
        priceLabel.textContent = `${priceEth} ETH per NFT`;
      }
      if (maxPerWalletLabel && quantityLimitPerWallet && quantityLimitPerWallet > 0n) {
        maxPerWalletLabel.textContent = `${quantityLimitPerWallet.toString()} Proof of Build per wallet`;
      }

      // Read supply stats
      const [minted, maxSupply] = await Promise.all([
        contract.totalSupply(TOKEN_ID),
        contract.maxTotalSupply(TOKEN_ID)
      ]);

      const mintedNum = Number(minted.toString());
      const maxNum =
        maxSupply && maxSupply > 0n
          ? Number(maxSupply.toString())
          : (maxClaimableSupply && maxClaimableSupply > 0n
              ? Number(maxClaimableSupply.toString())
              : 10000);

      if (mintedEl) {
        const pct = (mintedNum / maxNum) * 100;
        mintedEl.textContent = `Minted: ${mintedNum.toLocaleString()} / ${maxNum.toLocaleString()} POB (${pct.toFixed(2)}%)`;
      }

      updateEstimated();
    } catch (err) {
      console.error("loadStats error", err);
      if (priceLabel) priceLabel.textContent = "0.0001 ETH per NFT (fallback)";
      if (mintedEl) mintedEl.textContent = "Minted: data unavailable";
    }
  }

  // ===== WALLET =====
  async function ensureBaseNetwork() {
    const chainIdHex = await window.ethereum.request({ method: "eth_chainId" });
    const current = parseInt(chainIdHex, 16);
    if (current !== BASE_CHAIN_ID) {
      await window.ethereum.request({
        method: "wallet_switchEthereumChain",
        params: [{ chainId: "0x" + BASE_CHAIN_ID.toString(16) }]
      });
    }
  }

  async function connectWallet() {
    if (!window.ethereum) {
      alert("No wallet detected. Please open in Base app or MetaMask.");
      return;
    }
    try {
      await window.ethereum.request({ method: "eth_requestAccounts" });
      await ensureBaseNetwork();

      writeProvider = new ethers.BrowserProvider(window.ethereum);
      signer = await writeProvider.getSigner();
      currentAccount = await signer.getAddress();

      const short = currentAccount.slice(0, 6) + "..." + currentAccount.slice(-4);
      connectBtn.textContent = short;
      connectBtn.disabled = true;
      setStatus("", true);
    } catch (err) {
      console.error("connectWallet error", err);
      setStatus(err.message || "Failed to connect wallet.", false);
    }
  }

  // ===== UI: ESTIMATE =====
  function updateEstimated() {
    if (!estText || !qtyInput) return;
    const q = parseInt(qtyInput.value || "1", 10);
    const quantity = isNaN(q) || q <= 0 ? 1 : q;

    let priceEth = 0.0001;
    if (onchainPricePerToken != null) {
      try {
        priceEth = Number(ethers.formatEther(onchainPricePerToken));
      } catch (_) {}
    }
    const totalEth = priceEth * quantity;
    estText.textContent = `Estimated: ${quantity} Proof of Build â€¢ ${totalEth} ETH`;
  }

  // ===== MINT =====
  async function mintPOB() {
    if (!window.ethereum) {
      alert("No wallet detected. Please open in Base app or MetaMask.");
      return;
    }

    if (!signer || !currentAccount) {
      await connectWallet();
      if (!signer) return;
    }

    try {
      await ensureBaseNetwork();
    } catch (err) {
      setStatus("Please switch to Base mainnet (8453).", false);
      return;
    }

    const qRaw = parseInt(qtyInput.value || "1", 10);
    const quantity = isNaN(qRaw) || qRaw <= 0 ? 1 : qRaw;

    // use on-chain price & currency if available
    let pricePerTokenWei = onchainPricePerToken;
    if (pricePerTokenWei == null) {
      pricePerTokenWei = ethers.parseEther("0.0001");
    }
    let currency = onchainCurrency || ethers.ZeroAddress;

    const totalValue = pricePerTokenWei * BigInt(quantity);

    const contract = new ethers.Contract(CONTRACT_ADDRESS, POB_ABI, signer);

    const allowlistProof = {
      proof: [],
      quantityLimitPerWallet: 0,
      pricePerToken: 0,
      currency: ethers.ZeroAddress
    };

    try {
      setStatus("Waiting for wallet confirmationâ€¦", true);
      mintBtn.disabled = true;

      const tx = await contract.claim(
        currentAccount,
        TOKEN_ID,
        quantity,
        currency,
        pricePerTokenWei,
        allowlistProof,
        "0x",
        { value: totalValue }
      );

      setStatus("Transaction sent. Waiting for confirmationâ€¦", true);
      const receipt = await tx.wait();
      console.log("Mint receipt", receipt);

      setStatus("Mint successful! ðŸŽ‰", true);
      loadStats();
    } catch (err) {
      console.error("mintPOB error", err);
      setStatus(
        err.reason ||
          err.message ||
          "Mint failed. You may have already claimed or the phase is not active.",
        false
      );
    } finally {
      mintBtn.disabled = false;
    }
  }

  // ===== EVENTS =====
  connectBtn.addEventListener("click", connectWallet);
  mintBtn.addEventListener("click", mintPOB);
  qtyInput.addEventListener("input", updateEstimated);

  document.addEventListener("DOMContentLoaded", () => {
    updateEstimated();
    loadStats();
  });
</script>

</body>
</html>
