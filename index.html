<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Proof of Build</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content="Proof of Build — Base-native builder badge. Mint with ETH on Base." />

  <!-- Social / Miniapp preview -->
  <meta property="og:title" content="Proof of Build" />
  <meta property="og:description" content="Mint your onchain builder badge on Base." />
  <meta property="og:image" content="https://pob-lyart.vercel.app/og.png" />
  <meta name="fc:miniapp"
        content='{"version":"1","imageUrl":"https://pob-lyart.vercel.app/og.png","button":{"title":"Mint POB","action":{"type":"launch_miniapp","name":"Proof of Build","url":"https://pob-lyart.vercel.app","splashImageUrl":"https://pob-lyart.vercel.app/icon.png","splashBackgroundColor":"#0d1117"}}}' />
  <link rel="icon" href="icon.png" />

  <style>
    :root{
      --bg:#0b0f13; --panel:#0f141a; --text:#e6edf3; --muted:#8ea0ae;
      --brand:#53e6ff; --ring:#224957; --rad:14px;
    }
    *{box-sizing:border-box}
    body{margin:0;min-height:100vh;display:flex;align-items:center;justify-content:center;
         background:#0b0f13;color:var(--text);font:500 16px/1.5 Inter,system-ui,sans-serif}
    .wrap{width:min(460px,92vw);background:var(--panel);border:1px solid #1e2a33;border-radius:18px;padding:20px}
    .hero{border-radius:12px;overflow:hidden;box-shadow:0 0 40px rgba(83,230,255,.08)}
    .hero img{width:100%;display:block}
    h1{margin:14px 0 4px;font-size:26px}
    .muted{color:var(--muted);font-size:14px}
    .row{margin-top:12px;display:flex;gap:10px}
    input,button{height:48px;border:none;border-radius:var(--rad);font-size:16px}
    input{flex:1;background:#12191f;color:var(--text);padding:0 12px;border:1px solid #20303a}
    .btn{flex:1;cursor:pointer}
    .primary{background:linear-gradient(180deg,#53e6ff,#1fbfd9);color:#02222b;font-weight:700}
    .ghost{background:transparent;color:var(--text);border:1px solid var(--ring)}
    .addr{margin-top:8px;font-size:13px;color:var(--muted)}
    .help{margin-top:10px;font-size:13px}
    .help a{color:#7bdaf0;text-decoration:none}
  </style>
</head>

<body>
  <div class="wrap">
    <div class="hero"><img src="og.png" alt="POB"></div>
    <h1>Proof of Build</h1>
    <div class="muted">Mint your onchain builder badge and join early Base miniapp creators.</div>

    <div class="row">
      <input id="qty" type="number" min="1" value="1" />
    </div>
    <div class="row">
      <button id="mintBtn" class="btn primary">Mint POB</button>
      <button id="connectBtn" class="btn ghost">Connect wallet</button>
    </div>
    <div class="addr" id="acct">Wallet: not connected</div>

    <div class="help" id="noProviderHelp" style="display:none">
      No injected wallet found in this in-app view.
      <a href="https://pob-lyart.vercel.app" target="_blank" rel="noopener">Open in browser</a>
      and connect MetaMask / Coinbase / Rabby, or open this link from inside your wallet’s browser.
    </div>
  </div>

  <!-- viem UMD -->
  <script src="https://unpkg.com/viem@2.21.32/dist/index.umd.js"></script>
  <script>
    const CONTRACT = '0x01b91784C9B80d7fEfb206E2E1FC63ef1616386C';
    const TOKEN_ID = 0n;
    const PRICE_ETH = '0.0001';
    const NATIVE = '0xEeeeeEeeeEeEeeEeEeEeeEEEeeeeEeeeeeeeEEeE';

    const { createPublicClient, createWalletClient, http, parseEther, custom, getContract, chain, toHex } = viem;
    const base = chain.base;
    const pub = createPublicClient({ chain: base, transport: http() });

    // Minimal ABI: only what we call.
    const abi = [{
      "type":"function","name":"claim","stateMutability":"payable",
      "inputs":[
        {"name":"_receiver","type":"address"},
        {"name":"_tokenId","type":"uint256"},
        {"name":"_quantity","type":"uint256"},
        {"name":"_currency","type":"address"},
        {"name":"_pricePerToken","type":"uint256"},
        {"components":[
          {"name":"proof","type":"bytes32[]"},
          {"name":"quantityLimitPerWallet","type":"uint256"},
          {"name":"pricePerToken","type":"uint256"},
          {"name":"currency","type":"address"}],
         "name":"_allowlistProof","type":"tuple"},
        {"name":"_data","type":"bytes"}
      ],
      "outputs":[]
    }];

    // Prefer a real wallet provider if multiple are injected
    function getInjectedProvider() {
      const eth = window.ethereum;
      if (!eth) return null;
      if (eth.providers && Array.isArray(eth.providers)) {
        const pref = eth.providers.find(p => p.isCoinbaseWallet)
                 ||  eth.providers.find(p => p.isBraveWallet && p._initialized)
                 ||  eth.providers.find(p => p.isMetaMask && !p.isBraveWallet)
                 ||  eth.providers[0];
        return pref || eth;
      }
      return eth;
    }

    let provider = getInjectedProvider();
    let wallet, account;

    const $ = (id)=>document.getElementById(id);
    const acctEl = $('acct');
    const btnConnect = $('connectBtn');
    const btnMint = $('mintBtn');
    const qtyEl = $('qty');

    if (!provider) $('noProviderHelp').style.display = 'block';

    async function connectWallet(){
      provider = getInjectedProvider();
      if (!provider) {
        $('noProviderHelp').style.display = 'block';
        return;
      }
      // 1) request accounts first (more reliable on mobile)
      const addrs = await provider.request({ method: 'eth_requestAccounts' }).catch(e => { throw e; });
      account = addrs[0];

      // 2) create wallet client on current provider
      wallet = createWalletClient({ chain: base, transport: custom(provider) });

      // 3) ensure chain = Base
      try {
        await provider.request({ method: 'wallet_switchEthereumChain', params: [{ chainId: toHex(base.id) }] });
      } catch (e) {
        if (e && (e.code === 4902 || (e.message||'').includes('Unrecognized chain'))) {
          await provider.request({
            method: 'wallet_addEthereumChain',
            params: [{
              chainId: toHex(base.id),
              chainName: 'Base',
              rpcUrls: ['https://mainnet.base.org'],
              nativeCurrency: { name:'Ether', symbol:'ETH', decimals:18 },
              blockExplorerUrls: ['https://basescan.org']
            }]
          });
        } else {
          throw e;
        }
      }

      acctEl.textContent = 'Wallet: ' + account.slice(0,6) + '…' + account.slice(-4);
      btnConnect.textContent = 'Wallet connected';
    }

    async function mint(){
      try{
        if (!wallet || !account) await connectWallet();
        const qty = BigInt(Math.max(1, parseInt(qtyEl.value || '1', 10)));
        const priceWei = parseEther(PRICE_ETH);

        const hash = await wallet.writeContract({
          address: CONTRACT,
          abi,
          functionName: 'claim',
          args: [
            account,
            TOKEN_ID,
            qty,
            NATIVE,
            priceWei,
            { proof: [], quantityLimitPerWallet: 0n, pricePerToken: priceWei, currency: NATIVE },
            '0x'
          ],
          value: priceWei * qty,
          account
        });

        await pub.waitForTransactionReceipt({ hash });
        alert('✅ Mint success! Tx: ' + hash);
      } catch (err){
        let msg = String(err && (err.shortMessage || err.message || err));
        if (msg.includes('DropClaimInvalidTokenPrice')) {
          msg = 'Mint gagal: DropClaimInvalidTokenPrice. Cek di Thirdweb → Claim phase: currency = ETH (native), price = '+PRICE_ETH+' ETH, tokenId = '+Number(TOKEN_ID)+'.';
        } else if (msg.includes('user rejected')) {
          msg = 'Transaksi dibatalkan.';
        } else if (!getInjectedProvider()) {
          msg = 'Tidak ada wallet terdeteksi di webview. Buka link di browser / wallet.';
        }
        alert(msg);
      }
    }

    // Events
    btnConnect.addEventListener('click', () => {
      connectWallet().catch(e => alert(e.message || String(e)));
    });
    btnMint.addEventListener('click', () => {
      mint().catch(e => alert(e.message || String(e)));
    });

    // Update UI on account/chain change
    if (provider){
      provider.on?.('accountsChanged', (accs)=>{
        account = (accs && accs[0]) || null;
        acctEl.textContent = account ? 'Wallet: '+account.slice(0,6)+'…'+account.slice(-4) : 'Wallet: not connected';
      });
      provider.on?.('chainChanged', ()=>{/* no-op; we always switch to Base */});
    }
  </script>
</body>
</html>
