<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Proof of Build</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta
    name="description"
    content="Proof of Build — a Base-native collectible for early miniapp creators and supporters."
  />

  <!-- Open Graph -->
  <meta property="og:title" content="Proof of Build" />
  <meta
    property="og:description"
    content="Mint your Proof of Build — a Base-native collectible for early miniapp builders and supporters."
  />
  <meta property="og:image" content="https://pob-lyart.vercel.app/og.png" />
  <meta property="og:url" content="https://pob-lyart.vercel.app" />
  <meta property="og:type" content="website" />

  <link rel="icon" type="image/png" href="https://pob-lyart.vercel.app/icon.png" />

  <style>
    :root {
      --bg: #020617;
      --card-bg: rgba(15, 23, 42, 0.96);
      --border-subtle: rgba(148, 163, 184, 0.25);
      --accent: #7dd3fc;
      --accent-strong: #22d3ee;
      --text-main: #e5e7eb;
      --text-soft: #9ca3af;
    }

    * {
      box-sizing: border-box;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
    }

    body {
      margin: 0;
      min-height: 100vh;
      background:
        radial-gradient(circle at top, #0f172a 0, #020617 55%, #000 100%);
      color: var(--text-main);
      display: flex;
      justify-content: center;
      align-items: stretch;
      padding: 14px 8px;
    }

    main {
      width: 100%;
      max-width: 520px;
      margin: auto;
      background: var(--card-bg);
      border-radius: 20px;
      border: 1px solid var(--border-subtle);
      overflow: hidden;
      box-shadow: 0 20px 60px rgba(15, 23, 42, 0.95);
    }

    .hero-img {
      width: 100%;
      aspect-ratio: 16/10;
      object-fit: cover;
      display: block;
      border-bottom: 1px solid rgba(30, 64, 175, 0.6);
      box-shadow: 0 10px 35px rgba(15, 23, 42, 0.9);
    }

    .container {
      padding: 18px 16px 22px;
    }

    h1 {
      margin: 4px 0 2px;
      font-size: 22px;
      color: #e0f2fe;
      text-shadow: 0 0 18px rgba(56, 189, 248, 0.55);
    }

    .chain {
      font-size: 13px;
      color: var(--text-soft);
      margin-bottom: 8px;
    }

    .desc {
      font-size: 13px;
      color: #c7d2fe;
      margin: 6px 0 12px;
      line-height: 1.6;
    }

    .stat-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 13px;
      margin-top: 4px;
    }

    .label {
      color: var(--text-soft);
      font-size: 12px;
    }
    .value {
      color: var(--text-main);
      font-weight: 600;
      font-size: 13px;
    }
    .mono {
      font-family: "JetBrains Mono", "Fira Code", monospace;
      font-size: 12px;
    }

    .divider {
      margin: 16px 0 14px;
      border: none;
      border-top: 1px solid rgba(30, 41, 59, 0.95);
    }

    .qty-label {
      font-size: 12px;
      color: var(--text-soft);
      margin-bottom: 4px;
    }

    .qty-row {
      display: flex;
      gap: 10px;
      align-items: center;
      margin-bottom: 10px;
    }

    .qty-input-wrap {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 8px 12px;
      border-radius: 999px;
      border: 1px solid rgba(55, 65, 81, 0.9);
      background: radial-gradient(circle at top, #020617, #020617 65%, #000);
      box-shadow: inset 0 0 0 1px rgba(15, 23, 42, 0.8);
    }

    #qtyInput {
      border: none;
      outline: none;
      background: transparent;
      color: var(--text-main);
      font-size: 15px;
      width: 70px;
    }

    #qtyInput::placeholder {
      color: #4b5563;
    }

    .qty-unit {
      font-size: 13px;
      color: var(--text-soft);
      margin-left: 4px;
    }

    button {
      border: none;
      border-radius: 999px;
      cursor: pointer;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      transition: transform 0.08s ease-out, box-shadow 0.08s ease-out,
        opacity 0.08s ease-out, background 0.15s ease-out;
    }

    button:active {
      transform: translateY(1px) scale(0.99);
      box-shadow: none !important;
    }

    #connectBtn {
      width: 100%;
      padding: 10px 16px;
      margin-top: 10px;
      font-size: 14px;
      background: rgba(15, 23, 42, 0.95);
      color: #facc15;
      border: 1px solid rgba(250, 204, 21, 0.7);
      box-shadow: 0 0 0 1px rgba(15, 23, 42, 1),
        0 0 25px rgba(250, 204, 21, 0.28);
    }

    #mintBtn {
      flex: 1;
      padding: 10px 16px;
      font-size: 14px;
      background: linear-gradient(135deg, var(--accent-strong), #2563eb);
      color: #eff6ff;
      box-shadow: 0 12px 32px rgba(37, 99, 235, 0.9);
    }

    #mintBtn:disabled {
      opacity: 0.7;
      box-shadow: none;
      cursor: default;
    }

    .estimate {
      font-size: 12px;
      color: var(--text-soft);
      margin-top: 4px;
    }

    .status {
      margin-top: 6px;
      min-height: 16px;
      font-size: 12px;
    }
    .status.ok {
      color: #4ade80;
    }
    .status.err {
      color: #f97373;
    }

    .fine-print {
      margin-top: 14px;
      font-size: 11px;
      color: #6b7280;
      line-height: 1.6;
    }

    .link {
      color: #60a5fa;
      text-decoration: none;
    }
    .link:hover {
      text-decoration: underline;
    }

    @media (max-width: 520px) {
      body {
        padding: 10px 6px;
      }
      main {
        border-radius: 16px;
      }
      .container {
        padding: 16px 12px 20px;
      }
    }
  </style>

  <script src="https://cdn.jsdelivr.net/npm/ethers@6.11.1/dist/ethers.umd.min.js"></script>
</head>
<body>
<main>
  <!-- kalau og.png kamu simpan di repo sendiri, bisa ganti jadi /og.png -->
  <img
    src="https://pob-lyart.vercel.app/og.png"
    alt="Proof of Build"
    class="hero-img"
  />

  <div class="container">
    <h1>Proof of Build</h1>
    <div class="chain">Chain: <strong>Base</strong></div>

    <p class="desc">
      Proof of Build is a Base-native collectible for early miniapp creators
      and supporters. Mint as many as you want, keep it as your onchain
      builder badge.
    </p>

    <div class="stat-row">
      <div>
        <div class="label">Minted</div>
        <div class="value" id="mintedText">0 / ∞</div>
      </div>
      <div style="text-align:right;">
        <div class="label">Price</div>
        <div class="value" id="priceText">0.0001 ETH</div>
      </div>
    </div>

    <div class="stat-row" style="margin-top:8px;">
      <div>
        <div class="label">You hold</div>
        <div class="value" id="youHoldText">0 POB</div>
      </div>
      <div style="text-align:right;">
        <div class="label">Contract</div>
        <div class="value mono">
          <a
            class="link"
            href="https://basescan.org/address/0x01b91784C9B80d7fEfb206E2E1FC63ef1616386C"
            target="_blank"
          >0x01b9...6386C</a>
        </div>
      </div>
    </div>

    <hr class="divider" />

    <div class="qty-label">Quantity</div>
    <div class="qty-row">
      <div class="qty-input-wrap">
        <input
          id="qtyInput"
          type="number"
          min="1"
          step="1"
          value="1"
          inputmode="numeric"
        />
        <span class="qty-unit">NFT</span>
      </div>
      <button id="mintBtn">Mint POB</button>
    </div>

    <div class="estimate" id="estimateText">
      Estimated: 1 POB · 0.0001 ETH
    </div>

    <div class="status" id="mintStatus"></div>

    <button id="connectBtn">Connect wallet</button>

    <p class="fine-print">
      If you cast this link on Warpcast and the preview doesn’t show, make sure
      there is <strong>no extra space or newline after the URL</strong> in your
      cast.
    </p>
  </div>
</main>

<script>
  const CONTRACT_ADDRESS = "0x01b91784C9B80d7fEfb206E2E1FC63ef1616386C";
  const TOKEN_ID = 0n;
  const CHAIN_ID = 8453;
  const CHAIN_ID_HEX = "0x2105";
  const RPC_URL = "https://mainnet.base.org";

  const ABI = [
    "function totalSupply(uint256) view returns (uint256)",
    "function maxTotalSupply(uint256) view returns (uint256)",
    "function balanceOf(address account, uint256 id) view returns (uint256)",
    "function getActiveClaimConditionId(uint256 _tokenId) view returns (uint256)",
    "function getClaimConditionById(uint256 _tokenId, uint256 _conditionId) view returns (tuple(uint256 startTimestamp,uint256 maxClaimableSupply,uint256 supplyClaimed,uint256 quantityLimitPerWallet,bytes32 merkleRoot,uint256 pricePerToken,address currency,string metadata))",
    "function claim(address _receiver,uint256 _tokenId,uint256 _quantity,address _currency,uint256 _pricePerToken,(bytes32[] proof,uint256 quantityLimitPerWallet,uint256 pricePerToken,address currency) _allowlistProof,bytes _data) payable"
  ];

  const mintedText = document.getElementById("mintedText");
  const priceText = document.getElementById("priceText");
  const youHoldText = document.getElementById("youHoldText");
  const qtyInput = document.getElementById("qtyInput");
  const estimateText = document.getElementById("estimateText");
  const mintBtn = document.getElementById("mintBtn");
  const connectBtn = document.getElementById("connectBtn");
  const mintStatus = document.getElementById("mintStatus");

  let readProvider;
  let readContract;
  let currentPriceWei = null;
  let currentCurrency = null;
  let currentAccount = null;

  function setStatus(msg, ok) {
    mintStatus.textContent = msg || "";
    mintStatus.className = "status " + (msg ? (ok ? "ok" : "err") : "");
  }

  function getReadContract() {
    if (!readProvider) {
      readProvider = new ethers.JsonRpcProvider(RPC_URL);
      readContract = new ethers.Contract(CONTRACT_ADDRESS, ABI, readProvider);
    }
    return readContract;
  }

  async function loadOnchainInfo() {
    try {
      const c = getReadContract();
      const [totalSupplyBN, maxTotalSupplyBN, conditionIdBN] = await Promise.all([
        c.totalSupply(TOKEN_ID),
        c.maxTotalSupply(TOKEN_ID),
        c.getActiveClaimConditionId(TOKEN_ID)
      ]);

      const condition = await c.getClaimConditionById(TOKEN_ID, conditionIdBN);

      const totalSupply = Number(totalSupplyBN);
      let maxSupply = Number(maxTotalSupplyBN);
      if (!maxSupply || maxSupply === 0) {
        maxSupply = Number(condition.maxClaimableSupply);
      }

      currentPriceWei = condition.pricePerToken;
      currentCurrency = condition.currency;

      const priceEth = Number(ethers.formatEther(currentPriceWei));
      priceText.textContent = priceEth.toFixed(4) + " ETH";

      if (maxSupply && maxSupply > 0) {
        const pct = (totalSupply / maxSupply) * 100;
        mintedText.textContent =
          totalSupply.toLocaleString() +
          " / " +
          maxSupply.toLocaleString() +
          " (" +
          pct.toFixed(2) +
          "%)";
      } else {
        mintedText.textContent = totalSupply.toLocaleString() + " / ∞";
      }

      updateEstimate();
    } catch (err) {
      console.error("loadOnchainInfo error", err);
      mintedText.textContent = "data unavailable";
      priceText.textContent = "–";
    }
  }

  function updateEstimate() {
    if (!currentPriceWei) {
      estimateText.textContent = "Estimated: loading…";
      return;
    }
    let qty = parseInt(qtyInput.value || "0", 10);
    if (!Number.isFinite(qty) || qty <= 0) {
      estimateText.textContent = "Estimated: –";
      return;
    }
    const totalWei = currentPriceWei * BigInt(qty);
    const totalEth = Number(ethers.formatEther(totalWei));
    estimateText.textContent =
      "Estimated: " + qty + " POB · " + totalEth.toFixed(4) + " ETH";
  }

  async function refreshBalance() {
    if (!currentAccount) return;
    try {
      const c = getReadContract();
      const balBN = await c.balanceOf(currentAccount, TOKEN_ID);
      const bal = Number(balBN);
      youHoldText.textContent = bal.toLocaleString() + " POB";
    } catch (err) {
      console.error("balance error", err);
    }
  }

  async function connectWallet() {
    if (!window.ethereum) {
      alert(
        "No wallet detected. Open this page in Base Wallet, Rainbow, or a browser with MetaMask."
      );
      return;
    }
    try {
      const browserProvider = new ethers.BrowserProvider(window.ethereum);
      await browserProvider.send("eth_requestAccounts", []);

      const network = await browserProvider.getNetwork();
      if (Number(network.chainId) !== CHAIN_ID) {
        await window.ethereum.request({
          method: "wallet_switchEthereumChain",
          params: [{ chainId: CHAIN_ID_HEX }]
        });
      }

      const signer = await browserProvider.getSigner();
      const addr = await signer.getAddress();
      currentAccount = addr;

      const short = addr.slice(0, 6) + "..." + addr.slice(-4);
      connectBtn.textContent = short;

      await refreshBalance();
      setStatus("Wallet connected.", true);
    } catch (err) {
      console.error("connectWallet error", err);
      setStatus(err.message || "Failed to connect wallet.", false);
    }
  }

  async function handleMint() {
    if (!window.ethereum) {
      alert("No wallet detected. Open this page in Base Wallet or MetaMask.");
      return;
    }
    let qty = parseInt(qtyInput.value || "0", 10);
    if (!Number.isFinite(qty) || qty <= 0) {
      setStatus("Enter a quantity greater than 0.", false);
      return;
    }
    if (!currentPriceWei || !currentCurrency) {
      setStatus("Price data not loaded yet. Please wait a moment.", false);
      return;
    }

    try {
      mintBtn.disabled = true;
      setStatus("Waiting for wallet confirmation…", true);

      const browserProvider = new ethers.BrowserProvider(window.ethereum);
      const network = await browserProvider.getNetwork();
      if (Number(network.chainId) !== CHAIN_ID) {
        await window.ethereum.request({
          method: "wallet_switchEthereumChain",
          params: [{ chainId: CHAIN_ID_HEX }]
        });
      }

      const signer = await browserProvider.getSigner();
      const account = await signer.getAddress();
      currentAccount = account;

      const contract = new ethers.Contract(CONTRACT_ADDRESS, ABI, signer);

      const allowlistProof = {
        proof: [],
        quantityLimitPerWallet: 0,
        pricePerToken: currentPriceWei,
        currency: currentCurrency
      };

      const totalValue = currentPriceWei * BigInt(qty);

      const tx = await contract.claim(
        account,
        TOKEN_ID,
        qty,
        currentCurrency,
        currentPriceWei,
        allowlistProof,
        "0x",
        { value: totalValue }
      );

      setStatus("Minting… waiting for confirmation on-chain.", true);
      await tx.wait();

      setStatus("Mint successful! Your Proof of Build is on-chain.", true);
      await Promise.all([loadOnchainInfo(), refreshBalance()]);
    } catch (err) {
      console.error("mint error", err);
      if (err && err.message) {
        setStatus(err.message, false);
      } else {
        setStatus("Mint failed or was rejected.", false);
      }
    } finally {
      mintBtn.disabled = false;
    }
  }

  qtyInput.addEventListener("input", () => {
    if (qtyInput.value === "") return updateEstimate();
    const n = parseInt(qtyInput.value, 10);
    if (!Number.isFinite(n) || n <= 0) qtyInput.value = "1";
    updateEstimate();
  });

  connectBtn.addEventListener("click", connectWallet);
  mintBtn.addEventListener("click", handleMint);

  loadOnchainInfo();
</script>
</body>
</html>
